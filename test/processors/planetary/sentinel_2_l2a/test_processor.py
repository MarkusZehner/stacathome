import pytest
import shapely
from odc.geo.geobox import GeoBox

from stacathome.processors.sentinel2 import s2_pc_filter_newest_processing_time
from stacathome.processors.common import MGRSTiledItem, mgrs_tiled_overlap_filter_coverage
from stacathome.providers import get_provider


NEAR_TILE_CORNER = shapely.Point(704800, 5895040)  # EPSG:32632
NEAR_TILE_CORNER_SHIFT = shapely.Point(710800, 5901040)  # EPSG:32632


def create_test_geobox(center_p, crs='EPSG:32632', resolution=10, size_box=500):
    """Create a geobox centered at the given point with a specified resolution and size."""
    bbox = (
        center_p.x - size_box,  # left
        center_p.y - size_box,  # bottom
        center_p.x + size_box,  # right
        center_p.y + size_box,  # top
    )  # 1km x 1km
    geobox = GeoBox.from_bbox(
        bbox=bbox,
        crs=crs,
        resolution=resolution,
        tight=True,
    )
    return geobox


class TestSentinel2L2AProcessor:

    @pytest.mark.remote
    @pytest.mark.planetary
    def test_filtering(self):

        all_returns = {
            'S2A_MSIL2A_20230728T102601_R108_T33UUV_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T33UUV_20230728T181354',
            'S2A_MSIL2A_20230728T102601_R108_T33UUU_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T33UUU_20230728T181350',
            'S2A_MSIL2A_20230728T102601_R108_T32UQE_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UQE_20230728T181354',
            'S2A_MSIL2A_20230728T102601_R108_T32UQD_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UQD_20230728T181350',
            'S2A_MSIL2A_20230728T102601_R108_T32UPE_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UPE_20230728T181650',
            'S2A_MSIL2A_20230728T102601_R108_T32UPD_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UPD_20230728T181408',
            'S2A_MSIL2A_20230725T101601_R065_T33UUV_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T33UUV_20230725T170750',
            'S2A_MSIL2A_20230725T101601_R065_T33UUU_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T33UUU_20230725T181025',
            'S2A_MSIL2A_20230725T101601_R065_T32UQE_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UQE_20230725T181017',
            'S2A_MSIL2A_20230725T101601_R065_T32UQD_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UQD_20230725T181017',
            'S2A_MSIL2A_20230725T101601_R065_T32UPE_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UPE_20230725T181018',
            'S2A_MSIL2A_20230725T101601_R065_T32UPD_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UPD_20230725T181018',
            'S2B_MSIL2A_20230723T102609_R108_T33UUV_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T33UUV_20230723T153953',
            'S2B_MSIL2A_20230723T102609_R108_T33UUU_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T33UUU_20230723T160506',
            'S2B_MSIL2A_20230723T102609_R108_T32UQE_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UQE_20230723T154247',
            'S2B_MSIL2A_20230723T102609_R108_T32UQD_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UQD_20230723T153953',
            'S2B_MSIL2A_20230723T102609_R108_T32UPE_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UPE_20230723T154004',
            'S2B_MSIL2A_20230723T102609_R108_T32UPD_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UPD_20230723T154256',
            'S2B_MSIL2A_20230720T101609_R065_T33UUV_20230720T173415',
            'S2B_MSIL2A_20230720T101609_R065_T33UUU_20230720T180159',
            'S2B_MSIL2A_20230720T101609_R065_T32UQE_20230720T180206',
            'S2B_MSIL2A_20230720T101609_R065_T32UQD_20230720T181746',
            'S2B_MSIL2A_20230720T101609_R065_T32UPE_20230720T181335',
            'S2B_MSIL2A_20230720T101609_R065_T32UPD_20230720T182003',
            'S2A_MSIL2A_20230718T102601_R108_T33UUV_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T33UUV_20230718T200642',
            'S2A_MSIL2A_20230718T102601_R108_T33UUU_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T33UUU_20230718T195743',
            'S2A_MSIL2A_20230718T102601_R108_T32UQE_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UQE_20230718T195741',
            'S2A_MSIL2A_20230718T102601_R108_T32UQD_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UQD_20230718T195212',
            'S2A_MSIL2A_20230718T102601_R108_T32UPE_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UPE_20230718T195750',
            'S2A_MSIL2A_20230718T102601_R108_T32UPD_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UPD_20230718T195757',
            'S2A_MSIL2A_20230715T101601_R065_T33UUV_20230715T181521',
            'S2A_MSIL2A_20230715T101601_R065_T33UUU_20230715T181716',
            'S2A_MSIL2A_20230715T101601_R065_T32UQE_20230715T181718',
            'S2A_MSIL2A_20230715T101601_R065_T32UQD_20230715T181704',
            'S2A_MSIL2A_20230715T101601_R065_T32UPE_20230715T213344',
            'S2A_MSIL2A_20230715T101601_R065_T32UPD_20230715T181718',
            'S2B_MSIL2A_20230713T102649_R108_T33UUV_20230720T173402',
            'S2B_MSIL2A_20230713T102649_R108_T33UUU_20230720T173631',
            'S2B_MSIL2A_20230713T102649_R108_T32UQE_20230720T174210',
            'S2B_MSIL2A_20230713T102649_R108_T32UQD_20230720T172743',
            'S2B_MSIL2A_20230713T102649_R108_T32UPE_20230720T174712',
            'S2B_MSIL2A_20230713T102649_R108_T32UPD_20230720T174232',
            'S2B_MSIL2A_20230710T101609_R065_T33UUV_20230710T162038',
            'S2B_MSIL2A_20230710T101609_R065_T33UUU_20230710T183102',
            'S2B_MSIL2A_20230710T101609_R065_T32UQE_20230710T183114',
            'S2B_MSIL2A_20230710T101609_R065_T32UQD_20230710T183605',
            'S2B_MSIL2A_20230710T101609_R065_T32UPE_20230710T183605',
            'S2B_MSIL2A_20230710T101609_R065_T32UPD_20230710T183056',
        }

        filter_processing_time = {
            'S2A_MSIL2A_20230728T102601_R108_T33UUV_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T33UUU_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UQE_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UQD_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UPE_20241020T040431',
            'S2A_MSIL2A_20230728T102601_R108_T32UPD_20241020T040431',
            'S2A_MSIL2A_20230725T101601_R065_T33UUV_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T33UUU_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UQE_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UQD_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UPE_20241017T005903',
            'S2A_MSIL2A_20230725T101601_R065_T32UPD_20241017T005903',
            'S2B_MSIL2A_20230723T102609_R108_T33UUV_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T33UUU_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UQE_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UQD_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UPE_20241020T144323',
            'S2B_MSIL2A_20230723T102609_R108_T32UPD_20241020T144323',
            'S2B_MSIL2A_20230720T101609_R065_T33UUV_20230720T173415',
            'S2B_MSIL2A_20230720T101609_R065_T33UUU_20230720T180159',
            'S2B_MSIL2A_20230720T101609_R065_T32UQE_20230720T180206',
            'S2B_MSIL2A_20230720T101609_R065_T32UQD_20230720T181746',
            'S2B_MSIL2A_20230720T101609_R065_T32UPE_20230720T181335',
            'S2B_MSIL2A_20230720T101609_R065_T32UPD_20230720T182003',
            'S2A_MSIL2A_20230718T102601_R108_T33UUV_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T33UUU_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UQE_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UQD_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UPE_20241019T041854',
            'S2A_MSIL2A_20230718T102601_R108_T32UPD_20241019T041854',
            'S2A_MSIL2A_20230715T101601_R065_T33UUV_20230715T181521',
            'S2A_MSIL2A_20230715T101601_R065_T33UUU_20230715T181716',
            'S2A_MSIL2A_20230715T101601_R065_T32UQE_20230715T181718',
            'S2A_MSIL2A_20230715T101601_R065_T32UQD_20230715T181704',
            'S2A_MSIL2A_20230715T101601_R065_T32UPE_20230715T213344',
            'S2A_MSIL2A_20230715T101601_R065_T32UPD_20230715T181718',
            'S2B_MSIL2A_20230713T102649_R108_T33UUV_20230720T173402',
            'S2B_MSIL2A_20230713T102649_R108_T33UUU_20230720T173631',
            'S2B_MSIL2A_20230713T102649_R108_T32UQE_20230720T174210',
            'S2B_MSIL2A_20230713T102649_R108_T32UQD_20230720T172743',
            'S2B_MSIL2A_20230713T102649_R108_T32UPE_20230720T174712',
            'S2B_MSIL2A_20230713T102649_R108_T32UPD_20230720T174232',
            'S2B_MSIL2A_20230710T101609_R065_T33UUV_20230710T162038',
            'S2B_MSIL2A_20230710T101609_R065_T33UUU_20230710T183102',
            'S2B_MSIL2A_20230710T101609_R065_T32UQE_20230710T183114',
            'S2B_MSIL2A_20230710T101609_R065_T32UQD_20230710T183605',
            'S2B_MSIL2A_20230710T101609_R065_T32UPE_20230710T183605',
            'S2B_MSIL2A_20230710T101609_R065_T32UPD_20230710T183056',
        }

        filter_processing_coverage = {
            'S2A_MSIL2A_20230715T101601_R065_T33UUV_20230715T181521',
            'S2A_MSIL2A_20230725T101601_R065_T33UUV_20241017T005903',
            'S2B_MSIL2A_20230710T101609_R065_T33UUV_20230710T162038',
            'S2B_MSIL2A_20230720T101609_R065_T33UUV_20230720T173415',
            }

        filter_processing_larger_coverage = {
            'S2A_MSIL2A_20230728T102601_R108_T32UQE_20241020T040431',
            'S2A_MSIL2A_20230725T101601_R065_T32UQE_20241017T005903',
            'S2B_MSIL2A_20230723T102609_R108_T32UQE_20241020T144323',
            'S2B_MSIL2A_20230720T101609_R065_T32UQE_20230720T180206',
            'S2A_MSIL2A_20230718T102601_R108_T32UQE_20241019T041854',
            'S2A_MSIL2A_20230715T101601_R065_T32UQE_20230715T181718',
            'S2B_MSIL2A_20230713T102649_R108_T32UQE_20230720T174210',
            'S2B_MSIL2A_20230710T101609_R065_T32UQE_20230710T183114',
            }
    
        provider = get_provider('planetary_computer')
        # processor = Sentinel2L2AProcessor()

        geobox = create_test_geobox(shapely.Point(710800, 5901040), resolution=100, size_box=10000, crs='EPSG:32632')
        area_of_interest = geobox.footprint('EPSG:4326', buffer=0, npoints=4)

        geobox_small = create_test_geobox(
            shapely.Point(740800, 5901040), resolution=100, size_box=100, crs='EPSG:32632'
        )
        roi_small = geobox_small.footprint('EPSG:4326', buffer=0, npoints=4)

        items = provider.request_items(
            collection='sentinel-2-l2a',
            starttime='2023-07-10',
            endtime='2023-07-30',
            roi=area_of_interest,
        )
        s2_items = [MGRSTiledItem(item) for item in items]
        assert len(items) == len(all_returns)

        only_newer_processing = s2_pc_filter_newest_processing_time(s2_items)
        assert len(only_newer_processing) == len(filter_processing_time)

        coverage_filtered_items = mgrs_tiled_overlap_filter_coverage(only_newer_processing, roi_small)
        assert len(coverage_filtered_items) == len(filter_processing_coverage)

        coverage_filtered_items_large = mgrs_tiled_overlap_filter_coverage(only_newer_processing, area_of_interest)
        assert len(coverage_filtered_items_large) == len(filter_processing_larger_coverage)
        
        assert {i.id for i in items} == all_returns
        assert {i.id for i in only_newer_processing} == filter_processing_time
        assert {i.id for i in coverage_filtered_items} == filter_processing_coverage
        assert {i.id for i in coverage_filtered_items_large} == filter_processing_larger_coverage

        assert  coverage_filtered_items[0].proj_code == 'EPSG:32633'
        assert  coverage_filtered_items[0].mgrs_tile == '33UUV'
